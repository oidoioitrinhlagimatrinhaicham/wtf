name: PURE RDP v10 (INSTANT DONE + TRUE FOREVER ALIVE)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Enable RDP + No NLA
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

      - name: Auto Login
        run: |
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon /t REG_SZ /d 1 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName /t REG_SZ /d "admin" /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword /t REG_SZ /d "Rdp2025!" /f

      - name: Auto Rearm
        run: schtasks /create /sc onstart /tn "Rearm" /tr "cscript //nologo slmgr.vbs /rearm" /ru SYSTEM /f

      - name: Connect Info & INSTANT EXIT
        run: |
          $ip = (iwr http://ifconfig.me -UseBasicParsing).Content
          Write-Host "========================================"
          Write-Host "RDP READY"
          Write-Host "IP   → $ip"
          Write-Host "User → admin"
          Write-Host "Pass → Rdp2025!"
          Write-Host "========================================"
          # Tạo file bat chạy ngầm, không spawn job PowerShell → GitHub không thấy gì
          @"
          @echo off
          :loop
          timeout /t 3600 >nul
          goto loop
          "@ | Out-File -FilePath "$env:TEMP\alive.bat" -Encoding ascii
          start "" "$env:TEMP\alive.bat"
