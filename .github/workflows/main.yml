name: CLEAN RDP + ANDROID FARM v7 (KEEP-ALIVE LAST)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Enable RDP + No NLA
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

      - name: Auto Login
        run: |
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon /t REG_SZ /d 1 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName /t REG_SZ /d "admin" /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword /t REG_SZ /d "Rdp2025!" /f

      - name: Auto Rearm 180-day
        run: schtasks /create /sc onstart /tn "Rearm" /tr "cscript //nologo slmgr.vbs /rearm" /ru SYSTEM /f

      - name: DONE – Connect Info
        run: |
          $ip = (iwr http://ifconfig.me -UseBasicParsing).Content
          Write-Host "RDP READY – IP: $ip  |  User: admin  |  Pass: Rdp2025!"

      # KEEP-ALIVE ĐẶT CUỐI CÙNG – SIÊU BỀN
      - name: Smart Keep-Alive Forever (Last Step)
        run: |
          $job = { while($true) { Start-Sleep -Seconds 3600; Write-Output "Still alive $(Get-Date)" } }
          Start-Job -ScriptBlock $job
          Write-Host "Keep-Alive job started in background – runner will live forever"
